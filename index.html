<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>26th BN Merch Store</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .item { border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 10px; }
    .row { display:flex; gap:12px; align-items:flex-start; }
    img { width: 120px; height: 120px; object-fit: cover; border-radius: 10px; border:1px solid #eee; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; }
    .add { background: #2d7d46; color: white; }
    .low { color: #b00020; font-weight: bold; }
    .cart { border-top: 2px solid #eee; margin-top: 18px; padding-top: 12px; }
  </style>
</head>
<body>
  <h1>26th BN Merch Store</h1>

  <div id="items">Loading inventory…</div>

  <div class="cart">
    <h3>Your Cart</h3>
    <div id="cart"></div>
    <h3 id="total">Total: $0</h3>
    <button id="submit">SUBMIT ORDER</button>
    <p style="margin-top:10px;">
      All orders will be delivered during the next available FTX. Payments due in full and payable to Capt. Pope or in his absence LT. Kam.
    </p>
  </div>

<script>
const INVENTORY_URL = "./inventory.json?ts=" + Date.now(); // cache-buster

let inventory = null;
let cart = {}; // id -> qty

function money(n){ return "$" + Number(n).toFixed(2); }

function renderItems(){
  const el = document.getElementById("items");
  el.innerHTML = "";

  inventory.items.forEach(item => {
    const div = document.createElement("div");
    div.className = "item";

    const imgHtml = item.image ? `<img src="${item.image}" alt="${item.name}">` : "";

    const lowStock = (item.stock <= (item.threshold ?? 0));
    const lowHtml = lowStock ? `<div class="low">LOW STOCK</div>` : "";

    div.innerHTML = `
      <div class="row">
        ${imgHtml}
        <div>
          <h2 style="margin:0;">${item.name} - ${money(item.price)}</h2>
          <div style="margin:6px 0;">${item.description ?? ""}</div>
          <div>Stock: <b>${item.stock}</b> | Reorder at: <b>${item.threshold ?? 0}</b></div>
          ${lowHtml}
          <div style="margin-top:10px;">
            <button class="add">Add</button>
          </div>
        </div>
      </div>
    `;

    div.querySelector(".add").onclick = () => {
      cart[item.id] = (cart[item.id] || 0) + 1;
      renderCart();
    };

    el.appendChild(div);
  });
}

function renderCart(){
  const el = document.getElementById("cart");
  el.innerHTML = "";

  let total = 0;

  const entries = Object.entries(cart);
  if(entries.length === 0){
    el.textContent = "Cart is empty.";
    document.getElementById("total").textContent = "Total: $0";
    return;
  }

  entries.forEach(([id, qty]) => {
    const item = inventory.items.find(x => x.id === id);
    if(!item) return;

    total += item.price * qty;

    const row = document.createElement("div");
    row.style.margin = "8px 0";
    row.innerHTML = `
      <b>${item.name}</b> x ${qty} — ${money(item.price * qty)}
      <button style="margin-left:10px;" title="Remove one">-</button>
    `;
    row.querySelector("button").onclick = () => {
      cart[id] -= 1;
      if(cart[id] <= 0) delete cart[id];
      renderCart();
    };
    el.appendChild(row);
  });

  document.getElementById("total").textContent = "Total: " + money(total);
}

async function loadInventory(){
  const res = await fetch(INVENTORY_URL, { cache: "no-store" });
  if(!res.ok) throw new Error("Failed to load inventory.json: HTTP " + res.status);
  inventory = await res.json();
  renderItems();
  renderCart();
}

document.getElementById("submit").onclick = () => {
  alert("Order submission isn’t wired up yet. Next step is to send the cart to your Telegram bot or store it in orders[].");
};

loadInventory().catch(err => {
  document.getElementById("items").textContent = err.message;
});
</script>
</body>
</html>
